


{% extends "base.html" %}
{% load static %}
{% block container %}

<style>
.readbutton{
    display:none;
}
</style>

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-section set-bg" data-setbg=" {% static "img/breadcrumb-bg.jpg" %}">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="breadcrumb-text">
                        <h2>Messages</h2>
                        <div class="bt-option">
                            <a href="{% url "home" %}">Home</a>
                            <span>Messages
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- ChoseUs Section Begin -->
    <section class="choseus-section spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    {% include "trainer/sidebar.html" %}
                </div>
                <div class="col-lg-9">
                    <h5 class="text-white  mb-2"><span class="badge text-bg-success ml-1 notif-text ">{{unread}}</span> Unread Messages</h5>

                    <div class="list-group" id="notification">
                        {% if data %}
                        {% for i in data %}
                        {% if i.status %}

                        <div class="list-group-item mt-1 list{{i.id}}"  aria-current="true">
                            <div class="row">
                                <div class="col-9"><h6>{{i.message}}</h6></div>  
                                <div class="col-2"><h6>{{i.date}}</h6></div>
                                <div class="col-1"><i class="fa-solid fa-check-double readbutton{{i.id}}"></i></div>
                            </div>
                        </div>
                        {% else %}
                        <div class="list-group-item mt-1 list{{i.id}}"  aria-current="true" style="background-color:#D3D3D3;">
                            <div class="row">
                                <div class="col-7"><h6>{{i.message}}</h6></div>  
                                <div class="col-2"><h6>{{i.date}}</h6></div>
                                <div  class="col-3"><button class="btn btn-primary markreadbtn form-control" data-notification="{{i.id}}" data-index="{{i.id}}" id="readbtn{{i.id}}"><h6 style="color:white;">Mark Read</h6></button></div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                        
                        {% endif %}
                      </div>
                </div>
            </div>
            
        </div>
    </section>


<script>

    const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/trainer_notification/'
    );

    chatSocket.onopen = () => {
        console.log("✅ WebSocket connected");
        
    };

    chatSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        let current=parseInt($('.notif-text').text());
        $('.notif-text').text(current + 1);
        let sidebarCount=parseInt($('#sidebar-count').text());
        $('#sidebar-count').text(sidebarCount + 1);

        $('#notification').prepend(`<div class="list-group-item mt-1 list${data.id}"  aria-current="true" style="background-color:#D3D3D3;">
            <div class="row">
                <div class="col-7"><h6>${data.message}</h6></div>  
                <div class="col-2"><h6>${data.date}</h6></div>
                <div  class="col-3"><button class="btn btn-primary markreadbtn form-control" data-notification="${data.id}" data-index="${data.id}" id="readbtn${data.id}"><h6 style="color:white;">Mark Read</h6></button></div>
            </div>
            </div>`)
    };

    chatSocket.onclose = (event) => {
        console.log("❌ WebSocket closed");
       
    };


    $(document).on('click','.markreadbtn',function(){
        let index=$(this).attr('data-index');
        let not_id=$(this).attr('data-notification');
        
        $.ajax({
            url:"{% url 'mark_read' %}",
            data:{
                notification:not_id
            },
            dataType:'json',
            success:function(res){
                if (res.bool===true){
                    console.log('done');
                    let current=parseInt($('.notif-text').text());
                    $('.notif-text').text(current - 1);
                    $('.list'+index).replaceWith(`
                    <div class="list-group-item mt-1 list${res.data.content}"  aria-current="true">
                            <div class="row">
                                <div class="col-9"><h6>${res.data.content}</h6></div>  
                                <div class="col-2"><h6>${res.data.created_date}</h6></div>
                                <div class="col-1"><i class="fa-solid fa-check-double readbutton${res.data.id}"></i></div>
                            </div>`);
                    $('#readbtn'+index).hide();
                    $('#sidebar-count').text(res.unread);
                    $('.readbutton'+index).removeClass('readbutton');
                }
                
            }
        });
    });



</script>

{% endblock container %}